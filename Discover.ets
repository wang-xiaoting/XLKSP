import router from '@ohos.router';
import {
  trendingItems,
  creators,
  recommendedItems,
  categories,
  TrendingItem,
  Creator,
  RecommendedItem,
  CategoryItem
} from './discoverData';

@Entry
@Component
struct Discover {
  @State currentCategory: string = 'recommended'
  @State searchText: string = ''

  @State trendingItems: TrendingItem[] = trendingItems
  @State creators: Creator[] = creators
  @State recommendedItems: RecommendedItem[] = recommendedItems

  @State recommendStartIndex: number = 0

  private categories: CategoryItem[] = categories

  @Builder Header() {
    Row() {
      Button() {
        Text('â†').fontSize(20).fontColor('#FFFFFF')
      }
      .backgroundColor('transparent')
      .onClick(() => { router.back() })

      Text('å‘ç°').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
    .padding(20)
    .borderColor('rgba(255, 255, 255, 0.1)')
    .borderWidth({ bottom: 1 })
  }

  @Builder SearchBar() {
    Row() {
      Text('ğŸ”').fontSize(16).opacity(0.7).margin({ right: 10 })
      TextInput({ placeholder: 'æœç´¢éŸ³ä¹ã€è§†é¢‘æˆ–åˆ›ä½œè€…' })
        .backgroundColor('transparent')
        .placeholderColor('rgba(255, 255, 255, 0.7)')
        .fontSize(14)
        .fontColor('#FFFFFF')
        .width('100%')
        .onChange((value: string) => { 
          this.searchText = value
          if (value.trim()) {
            router.pushUrl({ url: 'pages/SearchResult', params: { searchText: value } })
          }
        })
    }
    .width('100%')
    .padding({ left: 15, right: 15, top: 10, bottom: 10 })
    .margin(15)
    .borderRadius(20)
    .backgroundColor('rgba(255, 255, 255, 0.1)')
  }

  @Builder TrendingSection() {
    Column() {
      Row() {
        Text('æ­£åœ¨æµè¡Œ').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
        Text('æŸ¥çœ‹å…¨éƒ¨')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .opacity(0.8)
          .onClick(() => { router.pushUrl({ url: 'pages/TrendingAll' }) })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 15 })

      Grid() {
        ForEach(this.trendingItems.slice(0, 2), (item: TrendingItem) => {
          GridItem() {
            Stack() {
              Image(item.image).width('100%').height('100%').objectFit(ImageFit.Cover).opacity(0.8)
              Column() {
                Text(item.title).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
                Text(item.plays + 'æ¬¡æ’­æ”¾').fontSize(12).fontColor('#FFFFFF').opacity(0.8)
              }
              .width('100%').padding(15).alignItems(HorizontalAlign.Start).justifyContent(FlexAlign.End)
            }
            .width('100%').height(180).borderRadius(12)
          }
        })
      }
      .columnsTemplate('1fr 1fr').columnsGap(10).rowsGap(10)
    }
    .padding(15)
  }

  @Builder CreatorsSection() {
    Column() {
      Row() {
        Text('çƒ­é—¨åˆ›ä½œè€…').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
        Text('æŸ¥çœ‹å…¨éƒ¨').fontSize(14).fontColor('#FFFFFF').opacity(0.8)
          .onClick(() => { router.pushUrl({ url: 'pages/creators' }) })
      }
      .width('100%').justifyContent(FlexAlign.SpaceBetween).margin({ bottom: 15 })

      Scroll() {
        Row({ space: 15 }) {
          ForEach(this.creators, (creator: Creator) => {
            Column({ space: 8 }) {
              Image(creator.avatar).width(60).height(60).borderRadius(30)
              Text(creator.name)
                .fontSize(12)
                .fontColor('#FFFFFF')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .width(70)
                .textAlign(TextAlign.Center)
            }
            .onClick(() => {
              router.pushUrl({ url: 'pages/CreateProfile', params: { id: creator.id } })
            })
          })
        }
      }
      .scrollable(ScrollDirection.Horizontal)
    }
    .padding(15)
  }

  // æ¨èåŒºåªæ˜¾ç¤º4æ¡ï¼Œåˆ·æ–°æ—¶åˆ‡æ¢
  @Builder RecommendedSection() {
    Column() {
      Row() {
        Text('ä¸ºä½ æ¨è').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
        Text('åˆ·æ–°')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .opacity(0.8)
          .onClick(() => {
            const total = this.recommendedItems.length
            if (this.recommendStartIndex + 4 >= total) {
              this.recommendStartIndex = 0
            } else {
              this.recommendStartIndex += 4
            }
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 15 })

      Column() {
        ForEach(this.getRecommendedList(), (item: RecommendedItem) => {
          Row() {
            Image(item.thumbnail).width(100).height(60).borderRadius(8).objectFit(ImageFit.Cover)
            Column() {
              Text(item.title).fontSize(14).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
                .maxLines(2).textOverflow({ overflow: TextOverflow.Ellipsis }).margin({ bottom: 5 })
              Text(item.author + ' Â· ' + item.plays + 'æ¬¡æ’­æ”¾').fontSize(12).fontColor('#FFFFFF').opacity(0.8)
            }
            .layoutWeight(1).margin({ left: 15 }).alignItems(HorizontalAlign.Start)
          }
          .width('100%').margin({ bottom: 15 })
          // ç‚¹å‡»æ¯æ¡æ¨èè·³è½¬åˆ°è¯¦æƒ…é¡µ
          .onClick(() => {
            router.pushUrl({ url: 'pages/RecommendDetail', params: { item } })
          })
        })
      }
    }
    .padding(15)
  }

  // æ¨èåŒºå¤„ç†å‡½æ•°ï¼Œå§‹ç»ˆè¿”å›4æ¡
  getRecommendedList(): Array<RecommendedItem> {
    let total = this.recommendedItems.length
    let start = this.recommendStartIndex
    let end = start + 4 > total ? total : start + 4
    let showList: Array<RecommendedItem> = []
    if (end - start < 4) {
      showList = this.recommendedItems.slice(start, end).concat(
        this.recommendedItems.slice(0, 4 - (end - start))
      )
    } else {
      showList = this.recommendedItems.slice(start, end)
    }
    return showList
  }

  build() {
    Stack() {
      Column() {
        Column().width('100%').height('100%').backgroundColor('#121212').position({ x: 0, y: 0 })
        Column() {
          this.Header()
          this.SearchBar()
          Scroll() {
            Column() {
              this.TrendingSection()
              this.CreatorsSection()
              this.RecommendedSection()
            }
          }
          .scrollable(ScrollDirection.Vertical)
          .scrollBar(BarState.Off)
          .edgeEffect(EdgeEffect.Spring)
          .layoutWeight(1)
        }
        .width('100%')
      }
      .width('100%').height('100%')
    }
    .width('100%').height('100%').backgroundColor('#000000')
  }
}