import router from '@ohos.router';
import { DataManager } from '../utils/DataManager';
import preferences from '@ohos.data.preferences';
import promptAction from '@ohos.promptAction';

interface UserStats {
  following: number,
  followers: number,
  likes: number
}

interface Work {
  id: number,
  image: string,
  likes: number,
  url: Resource,
  author: string,
  description: string,
  isLiked: boolean,
  isCollected: boolean
}

interface NavItem {
  icon: string,
  label: string,
  route: string,
  active?: boolean
}

interface UserInfo {
  avatar: Resource,
  nickname: string,
  bio: string,
  gender: string
}

interface PrivacySettings {
  profileVisibility: boolean;
  showLikes: boolean;
  showCollections: boolean;
  showHistory: boolean;
  allowTagging: boolean;
  allowComments: boolean;
  allowMessages: boolean;
}

interface RouteParams {
  userInfo?: UserInfo,
  privacySettings?: PrivacySettings
}

type TabType = 'collections' | 'works' | 'likes' | 'history';

@Entry
@Component
struct Profile {
  @State username: string = 'èˆè¹ˆå°ç‹å­'
  @State followers: number = 12580
  @State following: number = 256
  @State likes: number = 125800
  @State userInfo: UserInfo = {
    avatar: $r('app.media.profile2'),
    nickname: 'èˆè¹ˆå°ç‹å­',
    bio: 'çƒ­çˆ±èˆè¹ˆï¼Œåˆ†äº«å¿«ä¹',
    gender: 'ç”·'
  }

  @State currentTab: TabType = 'works'
  @State userStats: UserStats = {
    following: 256,
    followers: 12580,
    likes: 125800
  }

  @State works: Work[] = [
    {
      id: 1,
      image: 'https://picsum.photos/200/200',
      likes: 42,
      url: $r('app.media.video'),
      author: 'æ©˜å­çš®',
      description: '#666è¢«åˆ¶è£äº†',
      isLiked: false,
      isCollected: false
    },
    {
      id: 2,
      image: 'https://picsum.photos/200/201',
      likes: 18,
      url: $r('app.media.video1'),
      author: 'æ©˜å­çš®',
      description: '#æˆ‘è¢«åšå±€äº†',
      isLiked: false,
      isCollected: false
    }
  ]

  @State likedVideos: Work[] = []
  @State collectedVideos: Work[] = []
  @State historyVideos: Work[] = []

  // æ·»åŠ åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;
  @State isRefreshing: boolean = false;
  @State showLikesDialog: boolean = false;

  private readonly tabNames: Record<TabType, string> = {
    'collections': 'æ”¶è—',
    'works': 'ä½œå“',
    'likes': 'å–œæ¬¢',
    'history': 'å†å²'
  }

  private readonly navItems: NavItem[] = [
    { icon: 'ğŸ ', label: 'é¦–é¡µ', route: 'Index', active: false },
    { icon: 'ğŸ”', label: 'å‘ç°', route: 'Discover', active: false },
    { icon: '+', label: 'åˆ›å»º', route: 'Create', active: false },
    { icon: 'ğŸ’¬', label: 'æ¶ˆæ¯', route: 'Messages', active: false },
    { icon: 'ğŸ‘¤', label: 'æˆ‘', route: 'Profile', active: true }
  ]

  private dataManager: DataManager = DataManager.getInstance();

  // æ·»åŠ ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½
  async onRefresh() {
    this.isRefreshing = true;
    try {
      await this.loadLikedAndCollectedVideos();
      await this.loadHistoryVideos();
      promptAction.showToast({ message: 'åˆ·æ–°æˆåŠŸ' });
    } catch (err) {
      promptAction.showToast({ message: 'åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isRefreshing = false;
    }
  }

  // ä¼˜åŒ–æ•°æ®åŠ è½½
  async aboutToAppear() {
    this.isLoading = true;
    try {
      // ä¼˜å…ˆä»æœ¬åœ°è¯»å–ç”¨æˆ·ä¿¡æ¯
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'userInfoPrefs');
      const userInfoStr = await prefs.get('userInfo', '') as string;
      
      // å¦‚æœæœ‰æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨æœ¬åœ°ä¿¡æ¯
      if (userInfoStr) {
        const localUserInfo = JSON.parse(userInfoStr) as UserInfo;
        this.userInfo = localUserInfo;
        this.username = localUserInfo.nickname;
        console.info('ä»æœ¬åœ°è¯»å–åˆ°ç”¨æˆ·ä¿¡æ¯:', userInfoStr);
      }

      // æ£€æŸ¥è·¯ç”±å‚æ•°ï¼Œå¦‚æœæœ‰æ–°çš„ç”¨æˆ·ä¿¡æ¯åˆ™æ›´æ–°
      const params = router.getParams() as RouteParams;
      if (params?.userInfo) {
        this.userInfo = params.userInfo;
        this.username = params.userInfo.nickname;
        // ä¿å­˜åˆ°æœ¬åœ°
        await prefs.put('userInfo', JSON.stringify(this.userInfo));
        await prefs.flush();
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰éšç§è®¾ç½®æ›´æ–°
      if (params?.privacySettings) {
        const privacyPrefs = await preferences.getPreferences(context, 'privacySettings');
        await privacyPrefs.put('settings', JSON.stringify(params.privacySettings));
        await privacyPrefs.flush();
      }

      // åˆå§‹åŒ–æ•°æ®
      await this.dataManager.init();
      await this.loadLikedAndCollectedVideos();
      await this.loadHistoryVideos();
    } catch (e) {
      console.error('åˆå§‹åŒ–æ•°æ®å¤±è´¥:', e);
      promptAction.showToast({ message: 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isLoading = false;
    }
  }

  aboutToDisappear() {
    // ç§»é™¤äº‹ä»¶ç›‘å¬
    globalThis.eventHub?.off('userInfoUpdated')
  }

  // ä¼˜åŒ–è§†é¢‘åŠ è½½
  private async loadLikedAndCollectedVideos() {
    try {
      const likedVideoIds = await this.dataManager.getLikedVideos();
      const collectedVideoIds = await this.dataManager.getCollectedVideos();

      this.likedVideos = this.works.filter(work => likedVideoIds.includes(work.id));
      this.collectedVideos = this.works.filter(work => collectedVideoIds.includes(work.id));
      this.userStats.likes = likedVideoIds.length;
    } catch (err) {
      console.error('åŠ è½½ç‚¹èµå’Œæ”¶è—è§†é¢‘å¤±è´¥:', err);
      promptAction.showToast({ message: 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  // ä¼˜åŒ–å†å²è®°å½•åŠ è½½
  private async loadHistoryVideos() {
    try {
      const historyVideoIds = await this.dataManager.getHistoryVideos();
      this.historyVideos = this.works.filter(work => historyVideoIds.includes(work.id));
    } catch (err) {
      console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', err);
      promptAction.showToast({ message: 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  // ä¼˜åŒ–Headerç»„ä»¶
  @Builder Header() {
    Column() {
      Row() {
        Button() {
          Text('â†')
            .fontSize(24)
            .fontColor('#FFFFFF')
        }
        .backgroundColor('transparent')
        .onClick(() => {
          router.back()
        })

        Blank()

        Button() {
          Text('âš™ï¸')
            .fontSize(24)
        }
        .backgroundColor('transparent')
        .onClick(() => {
          try {
            router.pushUrl({
              url: 'pages/setting',
              params: { showPrivacy: true }
            });
          } catch (error) {
            console.error('è·³è½¬å¤±è´¥:', error);
          }
        })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20 })

      Image(this.userInfo.avatar)
        .width(100)
        .height(100)
        .borderRadius(50)
        .border({ width: 2, color: 'rgba(255, 255, 255, 0.2)' })
        .margin({ top: 30, bottom: 15 })

      Text(this.userInfo.nickname)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ bottom: 8 })

      Text(this.userInfo.bio)
        .fontSize(14)
        .fontColor('rgba(255, 255, 255, 0.8)')
        .margin({ bottom: 15 })
        .textAlign(TextAlign.Center)

      Row() {
        Column() {
          Text(this.userStats.following.toString())
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
          Text('å…³æ³¨')
            .fontSize(12)
            .fontColor('rgba(255, 255, 255, 0.8)')
        }
        .onClick(() => {
          router.pushUrl({ url: 'pages/FollowingPage' })
        })

        Column() {
          Text(this.userStats.followers.toString())
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
          Text('ç²‰ä¸')
            .fontSize(12)
            .fontColor('rgba(255, 255, 255, 0.8)')
        }
        .margin({ left: 20, right: 20 })
        .onClick(() => {
          router.pushUrl({ url: 'pages/FollowersPage' })
        })

        Column() {
          Text(this.userStats.likes.toString())
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
          Text('è·èµ')
            .fontSize(12)
            .fontColor('rgba(255, 255, 255, 0.8)')
        }
        .onClick(() => {
          this.showLikesDialog = true;
        })
      }
      .margin({ bottom: 20 })

      Button('ç¼–è¾‘èµ„æ–™')
        .width(120)
        .height(36)
        .fontSize(14)
        .backgroundColor('rgba(255, 255, 255, 0.1)')
        .borderRadius(18)
        .fontColor('#FFFFFF')
        .onClick(() => {
          router.pushUrl({
            url: 'pages/ProfileEdit',
            params: {
              userInfo: this.userInfo
            }
          })
        })
    }
    .width('100%')
    .padding({ top: 20, bottom: 20 })
    .backgroundColor('transparent')
  }

  @Builder ContentTabs() {
    Row() {
      ForEach(['collections', 'works', 'likes', 'history'] as TabType[], (tab: TabType) => {
        Text(this.tabNames[tab])
          .fontSize(16)
          .fontColor(this.currentTab === tab ? '#FFFFFF' : 'rgba(255, 255, 255, 0.7)')
          .padding({ top: 15, bottom: 15 })
          .borderWidth({ bottom: this.currentTab === tab ? 2 : 0 })
          .borderColor('#FF0050')
          .onClick(() => {
            this.currentTab = tab
          })
      })
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceAround)
    .borderWidth({ bottom: 1 })
    .borderColor('rgba(255, 255, 255, 0.1)')
  }

  // ä¼˜åŒ–å†…å®¹ç½‘æ ¼
  @Builder ContentGrid() {
    if (this.isLoading) {
      LoadingProgress()
        .width(50)
        .height(50)
        .color('#FF0050')
    } else {
      Refresh({ refreshing: $$this.isRefreshing }) {
        Grid() {
          if (this.currentTab === 'works') {
            ForEach(this.works, (work: Work) => {
              GridItem() {
                Stack() {
                  Image($r('app.media.Videoicon'))
                    .width('100%')
                    .height('100%')
                    .objectFit(ImageFit.Cover)
                  Row() {
                    Text('â¤ï¸')
                      .fontSize(12)
                    Text(work.likes.toString())
                      .fontSize(12)
                      .fontColor('#FFFFFF')
                  }
                  .position({ x: 5, y: '90%' })
                }
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/videoplayer',
                    params: { videoId: work.id }
                  })
                })
              }
              .aspectRatio(1)
            })
          } else if (this.currentTab === 'likes') {
            ForEach(this.likedVideos, (work: Work) => {
              GridItem() {
                Stack() {
                  Image(work.image)
                    .width('100%')
                    .height('100%')
                    .objectFit(ImageFit.Cover)
                  Row() {
                    Text('â¤ï¸')
                      .fontSize(12)
                    Text(work.likes.toString())
                      .fontSize(12)
                      .fontColor('#FFFFFF')
                  }
                  .position({ x: 5, y: '90%' })
                }
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/videoplayer',
                    params: { videoId: work.id }
                  })
                })
              }
              .aspectRatio(1)
            })
          } else if (this.currentTab === 'collections') {
            ForEach(this.collectedVideos, (work: Work) => {
              GridItem() {
                Stack() {
                  Image(work.image)
                    .width('100%')
                    .height('100%')
                    .objectFit(ImageFit.Cover)
                  Row() {
                    Text('â¤ï¸')
                      .fontSize(12)
                    Text(work.likes.toString())
                      .fontSize(12)
                      .fontColor('#FFFFFF')
                  }
                  .position({ x: 5, y: '90%' })
                }
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/videoplayer',
                    params: { videoId: work.id }
                  })
                })
              }
              .aspectRatio(1)
            })
          } else if (this.currentTab === 'history') {
            ForEach(this.historyVideos, (work: Work) => {
              GridItem() {
                Stack() {
                  Image(work.url)
                    .width('100%')
                    .height('100%')
                    .objectFit(ImageFit.Cover)
                  Row() {
                    Text('â¤ï¸')
                      .fontSize(12)
                    Text(work.likes.toString())
                      .fontSize(12)
                      .fontColor('#FFFFFF')
                  }
                  .position({ x: 5, y: '90%' })
                }
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/videoplayer',
                    params: { videoId: work.id }
                  })
                })
              }
              .aspectRatio(1)
            })
          }
        }
        .columnsTemplate('1fr 1fr 1fr')
        .columnsGap(2)
        .rowsGap(2)
        .padding(2)
      }
      .onRefreshing(() => {
        this.onRefresh();
      })
    }
  }

  @Builder BottomNav() {
    Row() {
      ForEach(this.navItems, (item: NavItem) => {
        Column() {
          Text(item.icon)
            .fontSize(24)
          Text(item.label)
            .fontSize(12)
            .fontColor(item.active ? '#FF0050' : '#FFFFFF')
        }
        .onClick(() => {
          if (!item.active) {
            router.pushUrl({ url: `pages/${item.route}` })
          }
        })
      })
    }
    .width('100%')
    .height(60)
    .padding({ left: 20, right: 20 })
    .justifyContent(FlexAlign.SpaceAround)
    .backgroundColor('rgba(0, 0, 0, 0.8)')
    .borderWidth({ top: 1 })
    .borderColor('rgba(255, 255, 255, 0.1)')
  }

  getTabName(tab: TabType): string {
    return this.tabNames[tab]
  }

  @Builder LikesDialog() {
    if (this.showLikesDialog) {
      Stack() {
        Column(){}
          .backgroundColor('rgba(0,0,0,0.4)')
          .width('100%')
          .height('100%')
          .onClick(() => {
            this.showLikesDialog = false
          })
        Column() {
          Text('è·èµæ•°')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
          Text(this.userStats.likes.toString())
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF0050')
            .margin({ bottom: 20 })
          Button('å…³é—­')
            .width(100)
            .onClick(() => {
              this.showLikesDialog = false
            })
        }
        .padding(24)
        .backgroundColor('#fff')
        .borderRadius(12)
        .alignItems(HorizontalAlign.Center)
        .width(220)
        .position({ x: '50%', y: '50%' })
        .translate({ x: -110, y: -80 })
      }
      .width('100%')
      .height('100%')
      .zIndex(99)
    }
  }

  build() {
    Stack() {
      Column() {
        this.Header()
        this.ContentTabs()
        this.ContentGrid()
        this.BottomNav()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#121212')
      this.LikesDialog()
    }
    .width('100%')
    .height('100%')
  }

  @Builder MenuItem(title: string, icon: string) {
    Row() {
      Text(icon)
        .fontSize(20)
        .margin({ right: 10 })
      Text(title)
        .fontSize(16)
        .fontColor('#FFFFFF')
    }
    .width('100%')
    .height(50)
    .padding({ left: 20, right: 20 })
    .justifyContent(FlexAlign.Start)
    .alignItems(VerticalAlign.Center)
    .backgroundColor('#121212')
    .margin({ bottom: 1 })
  }

  private async recordVideoHistory() {
    const video = this.works[this.currentTab === 'works' ? 0 : this.currentTab === 'likes' ? 1 : 2];
    await this.dataManager.addToHistory(video.id);
  }
}