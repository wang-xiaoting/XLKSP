import router from '@ohos.router'
import picker from '@ohos.file.picker';
import prompt from '@ohos.prompt';

/**
 * æ¨¡å¼é€‰é¡¹æ¥å£
 * å®šä¹‰åˆ›å»ºå†…å®¹æ—¶å¯é€‰çš„æ¨¡å¼é€‰é¡¹
 */
interface ModeOption {
  key: string,    // æ¨¡å¼é”®å€¼
  icon: string,   // æ¨¡å¼å›¾æ ‡
  label: string   // æ¨¡å¼æ ‡ç­¾
}

/**
 * æ»¤é•œç±»å‹
 * å®šä¹‰å¯ç”¨çš„æ»¤é•œæ•ˆæœç±»å‹
 */
type FilterType = 'none' | 'warm' | 'cool' | 'vintage' | 'dramatic'

/**
 * å‘å¸ƒå†…å®¹æ•°æ®ç»“æ„
 */
interface PublishPayload {
  type: string;
  content: string;
  filter: FilterType;
  isPrivate: boolean;
  media: string;
  createdAt: string;
}

/**
 * åˆ›å»ºå†…å®¹é¡µé¢ç»„ä»¶
 * ç”¨äºåˆ›å»ºå’Œå‘å¸ƒæ–°çš„å†…å®¹
 */
@Entry
@Component
struct Create {
  @State currentMode: string = 'video'           // å½“å‰é€‰æ‹©çš„åˆ›å»ºæ¨¡å¼
  @State previewContent: string = ''             // é¢„è§ˆå†…å®¹
  @State selectedFilter: FilterType = 'none'     // å½“å‰é€‰æ‹©çš„æ»¤é•œ
  @State isPrivate: boolean = false              // æ˜¯å¦è®¾ä¸ºç§å¯†
  @State selectedMedia: string = ''              // é€‰ä¸­çš„åª’ä½“æ–‡ä»¶è·¯å¾„
  @State isPublishing: boolean = false           // å‘å¸ƒä¸­çŠ¶æ€

  // åˆ›å»ºæ¨¡å¼é€‰é¡¹é…ç½®
  private modeOptions: ModeOption[] = [
    { key: 'video', icon: 'ğŸ¥', label: 'è§†é¢‘' },
    { key: 'photo', icon: 'ğŸ“·', label: 'ç…§ç‰‡' },
    { key: 'music', icon: 'ğŸµ', label: 'éŸ³ä¹' },
    { key: 'text', icon: 'ğŸ“', label: 'æ–‡å­—' }
  ]

  /**
   * ä»ç›¸å†Œé€‰æ‹©åª’ä½“æ–‡ä»¶
   */
  async selectFromGallery() {
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const result: picker.PhotoSelectResult = await photoPicker.select({
        MIMEType: this.currentMode === 'video' ? picker.PhotoViewMIMETypes.VIDEO_TYPE : picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      });

      if (result && result.photoUris && result.photoUris.length > 0) {
        this.selectedMedia = result.photoUris[0];
        this.previewContent = this.selectedMedia;
        console.info('Selected media:', this.selectedMedia);
      }
    } catch (err) {
      console.error('Failed to select media:', err);
      prompt.showToast({
        message: 'é€‰æ‹©åª’ä½“æ–‡ä»¶å¤±è´¥',
        duration: 2000
      });
    }
  }

  /**
   * å‘å¸ƒå†…å®¹åŠŸèƒ½
   */
  async publishContent() {
    if (this.isPublishing) {
      return;
    }
    if (!this.previewContent || this.previewContent.length === 0) {
      prompt.showToast({
        message: 'è¯·å…ˆé€‰æ‹©æˆ–å¡«å†™å†…å®¹',
        duration: 2000
      });
      return;
    }
    this.isPublishing = true;

    // æ˜ç¡®ç±»å‹çš„å¯¹è±¡
    const payload: PublishPayload = {
      type: this.currentMode,
      content: this.previewContent,
      filter: this.selectedFilter,
      isPrivate: this.isPrivate,
      media: this.selectedMedia,
      createdAt: new Date().toISOString()
    };

    // æ¨¡æ‹Ÿå‘å¸ƒæ—¶ç”¨åˆ°payloadï¼Œé˜²æ­¢æœªè¯»æŠ¥é”™
    console.info('å‘å¸ƒæ•°æ®ï¼š', payload);

    try {
      // è¿™é‡Œåªåšæ¼”ç¤ºï¼šå‡è£…ç­‰å¾…1ç§’
      await new Promise<void>((resolve) => setTimeout(resolve, 1000));

      prompt.showToast({
        message: 'å‘å¸ƒæˆåŠŸï¼',
        duration: 2000
      });
      setTimeout(() => {
        router.back();
      }, 800);
    } catch (err) {
      prompt.showToast({
        message: 'å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        duration: 2000
      });
    } finally {
      this.isPublishing = false;
    }
  }

  /**
   * é¡µé¢å¤´éƒ¨æ„å»ºå™¨
   */
  @Builder Header() {
    Row() {
      Button() {
        Text('å–æ¶ˆ')
          .fontColor('#FFFFFF')
          .fontSize(16)
      }
      .backgroundColor('transparent')
      .onClick(() => {
        router.back()
      })

      Text('åˆ›å»ºå†…å®¹')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')

      Button() {
        Text(this.isPublishing ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒ')
          .fontColor(this.isPublishing ? '#AAAAAA' : '#FF0050')
          .fontSize(16)
      }
      .backgroundColor('transparent')
      .enabled(this.previewContent.length > 0 && !this.isPublishing)
      .onClick(() => {
        this.publishContent()
      })
    }
    .width('100%')
    .padding(15)
    .justifyContent(FlexAlign.SpaceBetween)
  }

  /**
   * æ¨¡å¼åˆ‡æ¢å™¨æ„å»ºå™¨
   * æ„å»ºåˆ›å»ºæ¨¡å¼çš„åˆ‡æ¢é€‰é¡¹
   */
  @Builder ModeSwitcher() {
    Row() {
      ForEach(this.modeOptions, (item: ModeOption) => {
        Column({ space: 5 }) {
          Text(item.icon)
            .fontSize(24)
          Text(item.label)
            .fontSize(12)
            .fontColor(this.currentMode === item.key ? '#FF0050' : '#FFFFFF')
        }
        .onClick(() => {
          this.currentMode = item.key
          this.previewContent = ''
          this.selectedMedia = ''
        })
      })
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceAround)
    .padding({ top: 15, bottom: 15 })
  }

  /**
   * é¢„è§ˆåŒºåŸŸæ„å»ºå™¨
   * æ ¹æ®å½“å‰æ¨¡å¼æ„å»ºä¸åŒçš„é¢„è§ˆç•Œé¢
   */
  @Builder PreviewArea() {
    Stack() {
      if (this.currentMode === 'video') {
        if (this.selectedMedia) {
          Video({
            src: this.selectedMedia,
            currentProgressRate: 1.0,
            controller: new VideoController()
          })
            .width('100%')
            .height('100%')
            .objectFit(ImageFit.Cover)
        } else {
          Column() {
            Text('ç‚¹å‡»å½•åˆ¶è§†é¢‘')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .opacity(0.8)
            Text('æˆ–')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .opacity(0.6)
              .margin({ top: 10, bottom: 10 })
            Button('ä»ç›¸å†Œé€‰æ‹©')
              .backgroundColor('#FF0050')
              .height(40)
              .width(120)
              .borderRadius(20)
              .onClick(() => {
                this.selectFromGallery()
              })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
      } else if (this.currentMode === 'photo') {
        if (this.selectedMedia) {
          Image(this.selectedMedia)
            .width('100%')
            .height('100%')
            .objectFit(ImageFit.Cover)
        } else {
          Column() {
            Text('ç‚¹å‡»æ‹æ‘„ç…§ç‰‡')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .opacity(0.8)
            Text('æˆ–')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .opacity(0.6)
              .margin({ top: 10, bottom: 10 })
            Button('ä»ç›¸å†Œé€‰æ‹©')
              .backgroundColor('#FF0050')
              .height(40)
              .width(120)
              .borderRadius(20)
              .onClick(() => {
                this.selectFromGallery()
              })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
      } else if (this.currentMode === 'music') {
        Column() {
          Text('ç‚¹å‡»å½•åˆ¶éŸ³é¢‘')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .opacity(0.8)
          Text('æˆ–')
            .fontSize(14)
            .fontColor('#FFFFFF')
            .opacity(0.6)
            .margin({ top: 10, bottom: 10 })
          Button('ä»éŸ³ä¹åº“é€‰æ‹©')
            .backgroundColor('#FF0050')
            .height(40)
            .width(120)
            .borderRadius(20)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        TextArea({ placeholder: 'åˆ†äº«ä½ çš„æƒ³æ³•...' })
          .placeholderColor('rgba(255, 255, 255, 0.6)')
          .backgroundColor('transparent')
          .fontColor('#FFFFFF')
          .height('100%')
          .width('100%')
          .onChange((value: string) => {
            this.previewContent = value
          })
      }
    }
    .width('100%')
    .height('50%')
    .backgroundColor('rgba(255, 255, 255, 0.1)')
    .borderRadius(20)
  }

  /**
   * å·¥å…·æ æ„å»ºå™¨
   * æ„å»ºå†…å®¹ç¼–è¾‘å·¥å…·æ ï¼ŒåŒ…å«æ»¤é•œé€‰æ‹©å’Œéšç§è®¾ç½®
   */
  @Builder ToolBar() {
    Column({ space: 15 }) {
      // æ»¤é•œé€‰æ‹©å™¨ï¼ˆéæ–‡å­—æ¨¡å¼æ—¶æ˜¾ç¤ºï¼‰
      if (this.currentMode !== 'text') {
        Row() {
          Text('æ»¤é•œ')
            .fontSize(16)
            .fontColor('#FFFFFF')
          Scroll() {
            Row({ space: 10 }) {
              ForEach(['none', 'warm', 'cool', 'vintage', 'dramatic'], (filter: FilterType) => {
                Column() {
                  Text(filter)
                    .fontSize(14)
                    .fontColor(this.selectedFilter === filter ? '#FF0050' : '#FFFFFF')
                }
                .backgroundColor(this.selectedFilter === filter ? 'rgba(255, 0, 80, 0.2)' : 'transparent')
                .padding(10)
                .borderRadius(15)
                .onClick(() => {
                  this.selectedFilter = filter
                })
              })
            }
          }
          .scrollable(ScrollDirection.Horizontal)
          .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 15, right: 15 })
      }

      // éšç§è®¾ç½®
      Row() {
        Text('è®¾ä¸ºç§å¯†')
          .fontSize(16)
          .fontColor('#FFFFFF')
        Toggle({ type: ToggleType.Switch, isOn: this.isPrivate })
          .selectedColor('#FF0050')
          .switchPointColor('#FFFFFF')
          .onChange((isOn: boolean) => {
            this.isPrivate = isOn
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({ left: 15, right: 15 })
    }
  }

  /**
   * é¡µé¢ä¸»ä½“æ„å»ºå‡½æ•°
   * æ„å»ºæ•´ä¸ªåˆ›å»ºå†…å®¹é¡µé¢çš„UIç»“æ„
   */
  build() {
    Stack() {
      Column() {
        // èƒŒæ™¯
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('#121212')
          .position({ x: 0, y: 0 })

        // å†…å®¹
        Column() {
          this.Header()
          this.ModeSwitcher()
          this.PreviewArea()
          this.ToolBar()
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }
}